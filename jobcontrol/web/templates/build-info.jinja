{% extends 'base.jinja' %}

{% block page_title %}Job {{ job.id }}{% endblock %}

{% block page_body %}
<div class="container-fluid">

  {% if build.finished %}
    {% if build.skipped %}
      {% set row_class = 'warning' %}
      {% set status_line = 'Skipped' %}
    {% elif build.success %}
      {% set row_class = 'success' %}
      {% set status_line = 'Success' %}
    {% else %}
      {% set row_class = 'danger' %}
      {% set status_line = 'Failed' %}
    {% endif %}
  {% else %}
    {% set row_class = 'default' %}
    {% if build.started %}
      {% set status_line = 'Running' %}
    {% else %}
      {% set status_line = 'Created' %}
    {% endif %}
  {% endif %}

  <div class="pull-right">
    <div class="status-badge {{ row_class }}">
      <div class="line-top">Build</div>
      <div class="line-middle">{{ build.id }}</div>
      <div class="line-bottom">{{ status_line }}</div>
    </div>
  </div>

  <h1>
    <a href="{{ url_for('webui.job_info', job_id=job.id) }}">Job {{ job.id }}</a>
    &raquo;
    Build {{ build.id }}
  </h1>

  <h2>Job Information</h2>

  <table class="table table-bordered" style="max-width: 800px;">
    <tr>
      <th>Function</th>
      <td>
	<code>{{ job['function'] }}</code>
      </td>
    </tr>
    <tr>
      <th>Arguments</th>
      <td>
	<code>{{ job['args'] }}</code>
      </td>
    </tr>
    <tr>
      <th>Keyword arguments</th>
      <td>
	<code>{{ job['kwargs'] }}</code>
      </td>
    </tr>
    <tr>
      <th>Created</th>
      <td>{{ job['ctime'] }}</td>
    </tr>
    <tr>
      <th>Updated</th>
      <td>{{ job['mtime'] or 'Never' }}</td>
    </tr>
    <tr>
      <th>Dependencies</th>
      <td>
	  {% for dep in job['dependencies'] %}
	    <a href="{{ url_for('webui.job_info', job_id=dep) }}">
	      <div class="label label-primary label-round">
		{{ dep }}
	      </div>
	    </a>
	  {% endfor %}
      </td>
    </tr>
  </table>


  <h2>Build information</h2>

  <div class="progress progress-striped {% if build.progress_pc_n < 100 %}active{% endif %}"
       style="min-width: 200px;position:relative;line-height:40px;height:40px;background:#888;font-size:24px;">

       <div class="progress-bar"
	    role="progressbar"
	    aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
	    style="width: {{ build.progress_pc }}%; background-color: {{ build.progress_color }};">
       </div>

       <div style="position:absolute;top:0;left:0;right:0;
		   bottom:0;text-align:center;color:#fff;
		   text-shadow: 1px 1px 1px #000;">
		   {{ build['progress'] }}</div>

  </div>

  {% if build.retval %}
    <div class="panel panel-primary">
      <div class="panel-heading">
	<h3 class="panel-title">Return value</h3>
      </div>
      <div class="panel-body">
	<pre>{{ build.retval }}</pre>
      </div>
    </div>
  {% endif %}

  {% if build.exception %}
    <div class="panel panel-danger">
      <div class="panel-heading">
	<h3 class="panel-title">
	  <strong>Exception:</strong>
	  {{ build.exception }}
	</h3>
      </div>
      <div class="panel-body">
	<strong>Full traceback:</strong>
	<pre>{{ build.exception_tb }}</pre>
      </div>
    </div>
  {% endif %}

  <div class="row">

    <div class="col-md-6">

      <div class="jumbotron" style="font-size: 200%">
	<strong>Start time:</strong>
	{{ build.start_time }}<br>
	<strong>End time:</strong>
	{{ build.end_time }}
      </div>
    </div>

    <div class="col-md-6">

      <div class="row-fluid">

	<div class="col-xs-3">
	  <div class="panel panel-default">
	    <div class="panel-heading">
	      <h3 class="panel-title">Started</h3>
	    </div>
	    <div class="panel-body" style="text-align: center;">
	      {% if build.started %}
		<span class="label label-round-huge label-success">Yes</span>
	      {% else %}
		<span class="label label-round-huge label-warning">No</span>
	      {% endif %}
	    </div>
	  </div>
	</div>

	<div class="col-xs-3">
	  <div class="panel panel-default">
	    <div class="panel-heading">
	      <h3 class="panel-title">Finished</h3>
	    </div>
	    <div class="panel-body" style="text-align: center;">
	      {% if build.finished %}
		<span class="label label-round-huge label-success">Yes</span>
	      {% else %}
		<span class="label label-round-huge label-warning">No</span>
	      {% endif %}
	    </div>
	  </div>
	</div>

        <div class="col-xs-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Success</h3>
            </div>
            <div class="panel-body" style="text-align: center;">
              {% if build.finished %}
                {% if build.success %}
                  <span class="label label-round-huge label-success">Yes</span>
                {% else %}
                  <span class="label label-round-huge label-danger">No</span>
                {% endif %}
              {% else %}
                  <span class="label label-round-huge label-gray">?</span>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-xs-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Skipped</h3>
            </div>
            <div class="panel-body" style="text-align: center;">
              {% if build.finished %}
                {% if build.skipped %}
                  <span class="label label-round-huge label-warning">Yes</span>
                {% else %}
                  <span class="label label-round-huge label-success">No</span>
                {% endif %}
              {% else %}
                  <span class="label label-round-huge label-gray">?</span>
              {% endif %}
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <h2>Log messages</h2>

  <div class="log-messages">

    {% for record in messages %}

      {% if record.levelno <= 10 %}
	{% set row_class = 'debug' %}
      {% elif record.levelno <= 20 %}
	{% set row_class = 'info' %}
      {% elif record.levelno <= 30 %}
	{% set row_class = 'warning' %}
      {% elif record.levelno <= 40 %}
	{% set row_class = 'error' %}
      {% else %}
	{% set row_class = 'critical' %}
      {% endif %}

      <div class="message msg-{{ row_class }}">

	<div class="message-header">
	  <span class="levelname">{{ record.levelname }}</span>
	  <span class="date">{{ record.created }}</span>
	  <span class="logger-name">{{ record.name }}</span>
	  <span class="file">
	    <span class="filename">
	      {{- record.filename|escape -}}
	    </span>:<span class="lineno">
	      {{- record.lineno|escape -}}
	    </span>
	  </span>

	  <span class="function">
	    <span class="module">
	      {{- record.module|escape -}}
	    </span>.<span class="funcname">
	      {{- record.funcName|escape -}}
	    </span>
	  </span>
	</div>

	<div class="message-text">
	  {{ record.message|escape }}
	</div>

      </div>
    {% endfor %}

  </div>

    <br></br>

</div>
{% endblock %}
